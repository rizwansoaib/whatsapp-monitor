<!DOCTYPE html>
<html>

<head>
    <title>Live Online Monitor</title>
    <link rel="stylesheet" href="theme.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>

    <!-- Keeping original script refs just in case, though styles are overridden -->
    <script src="./../../assets/bts/jq.js"></script>
</head>

<body>

    <div class="main-container">

        <!-- Top Header -->
        <div class="top-bar">
            <h1 class="glitch" data-text="TrackWapp // TARGET MONITORING">TrackWapp // TARGET
                MONITORING</h1>
            <div class="sys-status">
                SYSTEM STATUS: <span style="color: var(--secondary-color)">ONLINE</span> |
                SECURE CONNECTION: <span style="color: var(--secondary-color)">ESTABLISHED</span>
            </div>
        </div>

        <!-- Row 2 Left: Target Profile -->
        <div class="left-panel">
            <div class="panel-header">
                <i class="fas fa-user-circle"></i> TARGET PROFILE
            </div>
            <div class="scanner-container">
                <div class="scanner-circle"></div>
                <div class="scanner-laser"></div> <!-- Enhanced Scan Line -->
                <div class="scanner-overlay"></div>
                <!-- Profile Image -->
                <img id="pro" class="profile-img" src="https://mdbootstrap.com/img/Photos/Avatars/img%20(30).jpg"
                    alt="Target">
            </div>

            <div class="target-info">
                <div class="info-row">
                    <span class="info-label">TARGET NAME</span>
                    <span class="info-value" id="name">Scanning...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">MOBILE NUMBER</span>
                    <span class="info-value" id="number">--</span>
                </div>
            </div>

            <!-- Status Box -->
            <div id="status_container" class="status-box status-offline">
                <span id="status" class="blink_text">OFFLINE</span>
            </div>

            <!-- Controls -->
            <div class="control-panel">
                <button class="cyber-btn" onclick="location.reload()">
                    <i class="fa fa-sync"></i> REFRESH
                </button>
                <button class="cyber-btn" onclick="change_sound()">
                    <i id="isound" class="fa fa-volume-mute"></i> SOUND
                </button>
                <button class="cyber-btn" onclick="change_notify()">
                    <i id="notify" class="fas fa-bell-slash"></i> NOTIFY
                </button>
            </div>
        </div>




        <!-- Row 2 Right: Activity Log -->
        <div class="right-panel">
            <div class="panel-header">
                <span>> ACTIVITY LOG</span>
                <span style="font-size: 12px; align-self: center;">LIVE DATA FEED</span>
            </div>

            <div style="overflow-y: auto; height: 100%;">
                <table class="terminal-table" id="history">
                    <thead>
                        <tr>
                            <th scope="col">TARGET</th>
                            <th scope="col">DATE</th>
                            <th scope="col">ONLINE TIME</th>
                            <th scope="col">OFFLINE TIME</th>
                            <th scope="col">DURATION</th>
                        </tr>
                    </thead>
                    <tbody id="history_body">
                        <!-- Javascript populates this -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Row 3: Live Terminal (Full Width) -->
        <div class="terminal-panel">
            <div class="panel-header">
                <i class="fas fa-terminal"></i> SYSTEM KERNEL // LIVE DECRYPTION
                <div class="telemetry-bar">
                    <span class="telemetry-item">RAM: <span id="tele-ram">0.00 MB</span></span> |
                    <span class="telemetry-item">PROC: <span id="tele-proc">0.00 MB</span></span> |
                    <span class="telemetry-item">BW: <span id="tele-bw">0.00 Mbps</span></span> |
                    <span class="telemetry-item">CPU: <span id="tele-cpu">0.0%</span></span>
                </div>
            </div>
            <div id="terminal-content" class="terminal-body">
                <!-- Typing text goes here -->
            </div>
        </div>

    </div>

    <!-- ALARM TOAST -->
    <div id="alarm-toast" class="toast-hidden">
        <div class="toast-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="toast-content">
            <div class="toast-title">SECURITY ALERT</div>
            <div class="toast-message" id="toast-msg">Target activity detected</div>
        </div>
        <div class="toast-loading"></div>
    </div>

    <!-- Logic Scripts -->
    <script>
        const electron = require("electron");
        const ipc = electron.ipcRenderer;
        const os = require('os');
        const http = require('http');
        const request = require('request');

        // -- Sound Toggle --
        function change_sound() {
            const isound = document.getElementById('isound');
            if (isound.classList.contains("fa-volume-mute")) {
                isound.className = "fa fa-volume-up";
                // Logic to enable sound in backend if needed
            } else {
                isound.className = "fa fa-volume-mute";
            }
        }

        // -- Notify Toggle --
        function change_notify() {
            const inoti = document.getElementById('notify');
            if (inoti.classList.contains("fa-bell")) {
                inoti.className = "fas fa-bell-slash";
            } else {
                inoti.className = "fas fa-bell";
            }
        }

        // -- Update Status Style --
        // This helper listens to changes in the "status" text to update the border color
        // Since the main logic isn't shown, I'm adding a MutationObserver to auto-update the UI class
        // whenever the text content of #status changes.
        const statusElement = document.getElementById('status');
        const statusContainer = document.getElementById('status_container');

        let lastSeenStatus = "";
        let lastNotifiedStatus = "OFFLINE";
        let debounceTimer = null;

        function showToast(title, message, type) {
            const toast = document.getElementById('alarm-toast');
            const toastMsg = document.getElementById('toast-msg');
            const toastTitle = document.querySelector('.toast-title');

            toastTitle.innerText = title;
            toastMsg.innerText = message;

            // Reset classes
            toast.className = 'toast-visible';
            if (type === 'online') {
                toast.classList.add('toast-success');
            } else if (type === 'offline') {
                toast.classList.add('toast-alert');
            }

            // Re-trigger animation
            const loader = document.querySelector('.toast-loading');
            loader.style.animation = 'none';
            loader.offsetHeight; /* trigger reflow */
            loader.style.animation = 'toast-timer 3s linear forwards';

            // Hide after 3 seconds
            setTimeout(() => {
                toast.className = 'toast-hidden';
            }, 3000);
        }

        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                const statusText = statusElement.innerText.trim().toUpperCase();

                // 1. Immediate Deduplication: If text is same as last update, ignore.
                if (statusText === lastSeenStatus) return;
                lastSeenStatus = statusText;

                console.log('Status Changed to:', statusText);

                // 2. Stability Check: Clear previous pending notification check
                if (debounceTimer) clearTimeout(debounceTimer);

                // 3. Wait for stability (e.g. 1 second) before notifying
                debounceTimer = setTimeout(() => {
                    const userName = document.getElementById('name').innerText;
                    const inoti = document.getElementById('notify');

                    // If after stabilization, the status is effectively different from what we last NOTIFIED
                    if (statusText !== lastNotifiedStatus) {
                        lastNotifiedStatus = statusText;

                        // Update UI styles based on stable status
                        if (statusText === 'ONLINE') {
                            statusContainer.className = 'status-box status-online';
                            statusElement.style.color = "var(--secondary-color)";

                            if (inoti && inoti.classList.contains('fa-bell')) {
                                console.log('Sending Stable Online Notification');
                                const profileImg = document.getElementById('pro').src;
                                new Notification('TrackWapp', {
                                    body: `${userName} is Online`,
                                    silent: false,
                                    icon: profileImg
                                });
                                const userNumber = document.getElementById('number').innerText;
                                showToast('TARGET ONLINE', `${userName} | ${userNumber}`, 'online');
                            }
                        } else if (statusText === 'OFFLINE') {
                            statusContainer.className = 'status-box status-offline';
                            statusElement.style.color = "var(--alert-color)";

                            if (inoti && inoti.classList.contains('fa-bell')) {
                                console.log('Sending Stable Offline Notification');
                                const profileImg = document.getElementById('pro').src;
                                new Notification('TrackWapp', {
                                    body: `${userName} is Offline`,
                                    silent: false,
                                    icon: profileImg
                                });
                                const userNumber = document.getElementById('number').innerText;
                                showToast('TARGET OFFLINE', `${userName} | ${userNumber}`, 'offline');
                            }
                        }
                    }
                }, 1000); // 1 Second Stability Buffer
            });
        });

        observer.observe(statusElement, { childList: true, subtree: true, characterData: true });

        // -- IP Fetch (Original Logic Preserved/Restored) --


        // -- IPC Listeners --

        var h = {}
        var noti_flag_dict = {}
        var noti_link_url = null;
        var userNotificationStates = {}; // Per-user state tracking
        var flag = 0
        let oldt;
        let startDate;


        function save(user, t1, t2, t) {
            var d = new Date();
            var curd = d.toLocaleDateString("en-GB").split(' ')[0]
            user = user.replace(/[^a-zA-Z0-9]/g, "")
            curd = curd.replace(/[^a-zA-Z0-9]/g, "")

            const surl = 'https://trackwapp.online/save/' + user + '/' + curd + '/' + t1 + '/' + t2 + '/' + t
            var xhr = new XMLHttpRequest();
            xhr.open("GET", surl);
            xhr.send()
        }


        // -- IPC Listeners --

        ipc.on('noti_link', function (event, noti_link) {
            //console.log("recvd db link",noti_link);
            noti_link_url = noti_link;
        })

        ipc.on('first', (event, h) => {
            // Handle initial data load
            console.log("Initial data received:", h);
        });

        ipc.on('online', (event, user) => {
            user = user ? user.trim() : "Unknown";
            console.log("Online Event:", user, "Current State:", userNotificationStates[user]);

            // Notification logic moved to MutationObserver


            document.getElementById('name').innerHTML = user;
            var status = document.getElementById('status')
            status.innerText = "ONLINE"; // Changed from innerHTML for consistency
            status.style.color = '#7dd4a8';


            isound = document.getElementById('isound');
            var sound_enabled = (isound.className == "fa fa-volume-up");

            if (sound_enabled) {
                var audio = new Audio('https://raw.githubusercontent.com/rizwansoaib/whatsapp-monitor/master/Chrome-Extension/WhatsApp%20Monitor/open.mp3');
                audio.play();
            }

            // Focus Window Logic
            if (sound_enabled || noti_send_flag) {
                ipc.send('focus-window');
            }

            if (flag == 0) {
                startDate = new Date();
                t1 = startDate.toTimeString().split(' ')[0]
                oldt = startDate.getTime();
                flag = 1
            }
        });





        // --- Optimized Terminal Logic ---
        const terminalContent = document.getElementById('terminal-content');
        const terminalLines = [
            "Initializing kernel subsystems...",
            "Loading module: net_surveillance_v2.o",
            "Decrypting traffic stream...",
            "Analyzing packet headers [TCP/UDP]...",
            "Handshake established: 192.168.X.X",
            "Bypassing firewall rules...",
            "Injecting payload: ghost_protocol.exe",
            "Access granted to secure node.",
            "Downloading metadata...",
            "Parsing user activity logs...",
            "Connection stable. Signal strength: 98%",
            "Buffer overflow prevention enabled.",
            "Monitoring socket connections...",
            "Encrypted key exchange successful.",
            "Target location triangulated.",
            "Scanning for vulnerabilities...",
            "Root access: DENIED. Retrying...",
            "Root access: GRANTED.",
            "Deploying surveillance bots...",
            "Synchronizing database...",
            "Log entry created: SYSTEM_EVENT_332",
            "Warning: Intrusion detected on port 8080",
            "Counter-measures activated.",
            "Tracing IP route...",
            "Updating heuristic algorithms...",
            "Data stream optimization: COMPLETE",
            "Bypassing SSL pinning...",
            "Injecting MITM certificate...",
            "Intercepting WebSocket frames...",
            "Deciphering Protobuf payload...",
            "Target device: Fingerprinted (Android 14)",
            "Battery level: 67% [Discharging]",
            "Cloning session token...",
            "Executing remote shellcode...",
            "Accessing contacts database...",
            "Synchronizing chat history [Chunk 1/5]...",
            "Scanning for 2FA bypass vulnerabilities...",
            "Establishing persistent backdoor...",
            "Masking network signature...",
            "Rerouting traffic via TOR nodes...",
            "Uploading encrypted dump to C2 server...",
            "Cleaning logging artifacts...",
            "System warning: CPU Temp 85Â°C",
            "Overclocking for faster decryption...",
            "Access key verification: SUCCESS",
            "Ghost Protocol: ACTIVE"
        ];

        let realLogQueue = [];

        ipc.on('system-log', (event, data) => {
            realLogQueue.push(`[${data.timestamp}] ${data.event}: ${data.detail}`);
            if (realLogQueue.length > 5) realLogQueue.shift();
        });

        ipc.on('performance-metrics', (event, metrics) => {
            const tr = document.getElementById('tele-ram');
            const tp = document.getElementById('tele-proc');
            const tb = document.getElementById('tele-bw');
            const tc = document.getElementById('tele-cpu');
            if (tr) tr.innerText = metrics.ram;
            if (tp) tp.innerText = metrics.process_size;
            if (tb) tb.innerText = metrics.bandwidth;
            if (tc) tc.innerText = metrics.cpu;
        });

        function typeWriter(text, element, i = 0) {
            if (i < text.length) {
                element.innerHTML += text.charAt(i);
                setTimeout(() => typeWriter(text, element, i + 1), 20);
            }
        }

        function addTerminalLine() {
            if (!terminalContent) return;

            // Maintain max 5 lines
            while (terminalContent.children.length >= 5) {
                terminalContent.removeChild(terminalContent.firstChild);
            }

            const line = document.createElement('div');
            line.className = 'terminal-line';
            line.style.fontFamily = "'Courier New', monospace";
            line.style.marginBottom = "2px";

            let textToType = "";

            // Mix real logs with fake ones
            if (realLogQueue.length > 0 && Math.random() > 0.6) {
                line.style.color = 'var(--secondary-color)';
                line.style.fontWeight = 'bold';
                textToType = `> ${realLogQueue.shift()}`;
            } else {
                const randomLine = terminalLines[Math.floor(Math.random() * terminalLines.length)];
                textToType = `> ${randomLine}`;
            }

            terminalContent.appendChild(line);
            typeWriter(textToType, line);
        }

        setInterval(addTerminalLine, 1500); // Slightly slower to allow typing to finish


        ipc.on('offline', (event, user) => {
            user = user ? user.trim() : "Unknown";
            console.log("Offline Event:", user, "Current State:", userNotificationStates[user]);

            // Notification logic moved to MutationObserver


            document.getElementById('status').innerText = 'OFFLINE';
            var pro = document.getElementById('pro')
            // pro.src='https://raw.githubusercontent.com/rizwansoaib/whatsapp-monitor/master/Chrome-Extension/WhatsApp%20Monitor/images/icons/128.png'; 
        });

        ipc.on('number', (event, num) => {
            document.getElementById('number').innerText = '+' + num;
        });

        ipc.on('whatsapp_username', (event, username) => {
            // document.getElementById('name').innerText = username;
        });

        ipc.on('contact_data', (event, data) => {
            // Update contact name mapping if needed
        });

        ipc.on('imgsrc', (event, url) => {
            var pro = document.getElementById('pro')
            if (url != undefined)
                pro.src = url;
        });

        ipc.on('data', (event, his) => {
            // Add row to history table
            //  his=[num,contact_name,curd,t1,t2,diff_time]
            // console.log(his+" contact.html")
            num = his[0];
            name = his[1];
            curd = his[2];
            t1 = his[3];
            t2 = his[4];
            t = his[5];

            save(num, t1, t2, t);

            const tableBody = document.getElementById('history_body');
            const newRow = tableBody.insertRow(0); // Insert at top
            newRow.insertCell(0).innerText = name;
            newRow.insertCell(1).innerText = curd;
            newRow.insertCell(2).innerText = t1;
            newRow.insertCell(3).innerText = t2;
            newRow.insertCell(4).innerText = t;


            inoti = document.getElementById('notify');
            noti_send_flag = false
            if (inoti.className == "fas fa-bell")
                noti_send_flag = true

            is_need_noti = noti_flag_dict[name]

            if (noti_link_url != null && noti_send_flag && is_need_noti == false) {
                request({
                    url: noti_link_url,
                    method: "POST",
                    json: true,
                    body: 'ðŸ“´ WhatsApp Monitor Offline : ' + name + ' ' + curd + ' ' + t1 + ' ' + t2 + ' ' + t,
                    headers: { 'User-Agent': "Mozilla/5.0 (Windows NT 10.0; Win64; x64)  AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.80 Safari/537.36" }

                }, function (error, response, body) {
                    noti_flag_dict[name] = true;
                });
            }
        });

    </script>

</body>

</html>